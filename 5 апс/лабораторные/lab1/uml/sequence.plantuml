@startuml Оформление подписки YouTube Premium

actor Пользователь

box "Клиентская система" #White
    participant "Браузер"
    participant "Клиентское приложение"
end box

box "Серверная система" #White
    participant "Сервер"
    database "База данных"
    queue "Очередь сообщений" as Queue
    participant "Сторонний сервис Google (Авторизация)" as GoogleAuth
    participant "Сторонний сервис Google (Платежи)" as GooglePayments
end box

participant "Платежная система"
participant "Банк"

group Начало оформления подписки
  group Взаимодействие пользователя с интерфейсом
    Пользователь -> "Браузер": Нажимает "Оформить подписку YouTube Premium"
    activate "Браузер"
    activate "Клиентское приложение"
    "Браузер" -> "Клиентское приложение": Отправляет событие "Начало оформления подписки"
    deactivate "Браузер"
  end
  group Проверка учетной записи
    "Клиентское приложение" -> "Сервер": Запрос на проверку учетной записи
    activate "Сервер"
    "Сервер" -> GoogleAuth: Проверка токена авторизации через OAuth 2.0
    activate GoogleAuth
    GoogleAuth --> "Сервер": Ответ с результатом авторизации
    deactivate GoogleAuth
    "Сервер" --> Queue: Отправка подтверждения авторизации
    activate Queue
    Queue -> "Клиентское приложение": Учетная запись подтверждена
    deactivate Queue
    deactivate "Сервер"
    deactivate "Клиентское приложение"
  end
end

group Выбор платежного метода
  group Запрос доступных профилей
    Пользователь -> "Браузер": Выбирает "Платежный профиль Google"
    activate "Браузер"
    "Браузер" -> "Клиентское приложение": Передает выбор пользователя
    activate "Клиентское приложение"
    "Клиентское приложение" -> GooglePayments: Запрос доступных платежных профилей через Google Wallet API
    activate GooglePayments
    GooglePayments --> "Клиентское приложение": Список доступных профилей
    deactivate GooglePayments
    "Клиентское приложение" -> "Браузер": Отображает доступные профили
    deactivate "Клиентское приложение"
    deactivate "Браузер"
  end
end

group Инициализация платежа
  group Передача платежного профиля
    Пользователь -> "Браузер": Выбирает платежный профиль
    activate "Браузер"
    "Браузер" -> "Клиентское приложение": Передает выбранный профиль
    deactivate "Браузер"
  end
  group Проверка доступности платежного метода
    activate "Клиентское приложение"
    "Клиентское приложение" -> GooglePayments: Инициализация платежа через Secure Payments API
    activate GooglePayments
    GooglePayments -> "Платежная система": Проверка доступности профиля
    activate "Платежная система"
    "Платежная система" --> GooglePayments: Подтверждение доступности
    deactivate "Платежная система"
    GooglePayments --> "Клиентское приложение": Платежный профиль подтвержден
    deactivate GooglePayments
    "Клиентское приложение" -> "Сервер": Отправка информации о платеже
    activate "Сервер"
    "Сервер" -> Queue: Отправка данных для обработки
    activate Queue
    Queue -> "Сервер": Получение подтверждения платежа
    deactivate Queue
  end
end

group Завершение транзакции
  group Сохранение информации о подписке
    "Сервер" -> "База данных": Сохранение информации о подписке
    activate "База данных"
    "База данных" --> "Сервер": Подтверждение сохранения
    deactivate "База данных"
  end
  group Обновление статуса подписки
    "Сервер" -> GooglePayments: Создание платежной транзакции через Google Pay API
    activate GooglePayments
    GooglePayments -> "Банк": Обработка транзакции через Payment Gateway
    activate "Банк"
    "Банк" --> GooglePayments: Успешная транзакция
    deactivate "Банк"
    GooglePayments --> "Сервер": Успешное завершение платежа
    deactivate GooglePayments
    "Сервер" -> Queue: Обновление статуса подписки
    activate Queue
    Queue -> "База данных": Запрос обновления статуса
    "База данных" --> Queue: Статус обновлен
    Queue --> "Сервер": Подтверждение обновления
    deactivate Queue
    deactivate "База данных"
    deactivate "Сервер"
  end
end

group Подтверждение подписки
  group Отображение подтверждения
    "Сервер" -> "Клиентское приложение": Подтверждение подписки
    activate "Клиентское приложение"
    "Клиентское приложение" -> "Браузер": Отображение подтверждения Premium
    activate "Браузер"
    Пользователь -> "Браузер": Видит сообщение об успешной подписке
    deactivate "Браузер"
    deactivate "Клиентское приложение"
  end
  group Обновление интерфейса
    "Браузер" -> "Клиентское приложение": Запрос обновлений статуса подписки
    "Клиентское приложение" -> "Сервер": Проверка статуса подписки
    activate "Сервер"
    "Сервер" -> "База данных": Получение текущего статуса
    activate "База данных"
    "База данных" --> "Сервер": Подтверждение Premium
    "Сервер" --> Queue: Обновление интерфейса
    Queue -> "Клиентское приложение": Статус Premium подтвержден
    deactivate Queue
    deactivate "База данных"
    "Клиентское приложение" -> "Браузер": Обновление интерфейса Premium
    deactivate "Сервер"
    deactivate "Клиентское приложение"
    deactivate "Браузер"
  end
end

group Уведомление пользователя
  group Генерация уведомления
    Пользователь -> "Браузер": Получает уведомление о подписке
    activate "Браузер"
    "Браузер" -> "Клиентское приложение": Запрос уведомления
    activate "Клиентское приложение"
    "Клиентское приложение" -> "Сервер": Генерация уведомления через Firebase Cloud Messaging
    activate "Сервер"
    "Сервер" -> GoogleAuth: Проверка токена авторизации
    activate GoogleAuth
    GoogleAuth --> "Сервер": Авторизация подтверждена
    deactivate GoogleAuth
    deactivate "Сервер"
    deactivate "Клиентское приложение"
    deactivate "Браузер"
  group Отправка уведомления
    "Сервер" -> Queue: Отправка уведомления
    activate Queue
    Queue -> "Браузер": Уведомление для пользователя
    deactivate Queue
  end
end

@enduml
