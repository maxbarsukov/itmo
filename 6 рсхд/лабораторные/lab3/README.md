# Лабораторная работа 3

## Вариант `368122`

<img alt="rikka-takanashi" src="https://github.com/maxbarsukov/itmo/blob/master/.docs/rikka-takanashi.gif" height="320">

> USB is a great backup... \
> Especially if USA fails.

|.pdf|.docx|
|-|-|
| [report](./docs/report.pdf) | [report](./docs/report.docx) |

## Задание

**Цель работы**: настроить процедуру периодического резервного копирования базы данных, сконфигурированной в ходе выполнения [лабораторной работы №2](https://github.com/maxbarsukov/itmo/tree/master/6%20%D1%80%D1%81%D1%85%D0%B4/%D0%BB%D0%B0%D0%B1%D0%BE%D1%80%D0%B0%D1%82%D0%BE%D1%80%D0%BD%D1%8B%D0%B5/lab2), а также разработать и отладить сценарии восстановления в случае сбоев.

Узел из предыдущей лабораторной работы используется в качестве основного. Новый узел используется в качестве резервного. Учётные данные для подключения к новому узлу **выдаёт преподаватель**. В сценариях восстановления необходимо использовать копию данных, *полученную на первом этапе* данной лабораторной работы.

### Этап 1. Резервное копирование

1. Настроить резервное копирование с основного узла на резервный следующим образом:
    - Периодические полные копии с помощью `SQL Dump`.
    - По расписанию (`cron`) раз в сутки, методом `SQL Dump` с сжатием. Созданные архивы должны сразу перемещаться на резервный хост, они не должны храниться на основной системе. Срок хранения архивов на резервной системе – *4 недели*. По истечении срока хранения, старые архивы должны автоматически уничтожаться.
2. Подсчитать, каков будет объем резервных копий спустя месяц работы системы, исходя из следующих условий:
    - Средний объем новых данных в БД за сутки: `650МБ`.
    - Средний объем измененных данных за сутки: `350МБ`.
3. Проанализировать результаты.

### Этап 2. Потеря основного узла

Этот сценарий подразумевает полную недоступность основного узла. Необходимо восстановить работу СУБД на **резервном** узле, продемонстрировать успешный запуск СУБД и доступность данных.

### Этап 3. Повреждение файлов БД

Этот сценарий подразумевает потерю данных (например, в результате сбоя диска или файловой системы) при сохранении доступности основного узла. Необходимо выполнить полное восстановление данных из резервной копии и перезапустить СУБД на **основном** узле.

Ход работы:
1. Симулировать сбой:
    - удалить с диска директорию WAL со всем содержимым.
2. Проверить работу СУБД, доступность данных, перезапустить СУБД, проанализировать результаты.
3. Выполнить восстановление данных из резервной копии, учитывая следующее условие:
    - исходное расположение дополнительных табличных пространств недоступно – разместить в другой директории и скорректировать конфигурацию.
4. Запустить СУБД, проверить работу и доступность данных, проанализировать результаты.

### Этап 4. Логическое повреждение данных

Этот сценарий подразумевает частичную потерю данных (в результате нежелательной или ошибочной операции) при сохранении доступности основного узла. Необходимо выполнить восстановление данных на **основном** узле следующим способом:
- Восстановление с использованием архивных WAL файлов. (СУБД должна работать в режиме архивирования WAL, потребуется задать параметры восстановления).

Ход работы:
1. В каждую таблицу базы добавить 2-3 новые строки, зафиксировать результат.
2. Зафиксировать время и симулировать ошибку:
    - удалить каждую вторую строку в любой таблице (`DELETE`)
3. Продемонстрировать результат.
4. Выполнить восстановление данных указанным способом.
5. Продемонстрировать и проанализировать результат.

---

### Требования к отчёту

Отчет должен быть **самостоятельным документом** (без ссылок на внешние ресурсы), содержать всю последовательность команд и исходный код скриптов по каждому пункту задания. Для демонстрации результатов приводить команду вместе с выводом (самой наглядной частью вывода, при необходимости).

### Вопросы к защите лабораторной работы:

1. Резервные копии: назначение; локальные и удаленные; полные и инкрементные; холодные и горячие.
2. Сравнение подходов `SQL Dump`, `FS Level Backup`, `Continuous Archiving`: применимость, преимущества, недостатки.
3. Как рассчитать объем пространства для хранения резервных копий, от чего зависит?
4. Как рассчитать требуемую производительность канала для выполнения резервных копий по сети, от чего зависит?
5. Какие факторы оказывают влияние на скорость восстановления, почему?

---

## Полезные ссылки

| Ссылка | Описание |
| --- | --- |
| [postgresql.org/docs/current/backup.html](https://www.postgresql.org/docs/current/backup.html) <br> [postgrespro.ru/docs/postgresql/current/backup](https://postgrespro.ru/docs/postgresql/current/backup) | Резервное копирование и восстановление |
| [postgresql.org/docs/current/continuous-archiving.html](https://www.postgresql.org/docs/current/continuous-archiving.html) <br> [postgrespro.ru/docs/postgresql/current/continuous-archiving](https://postgrespro.ru/docs/postgresql/current/continuous-archiving) | Непрерывное архивирование и восстановление на момент времени (Point-in-Time Recovery, PITR) |
| [neon.tech/postgresql/postgresql-administration/postgresql-backup-database](https://neon.tech/postgresql/postgresql-administration/postgresql-backup-database) | Туториал по использованию `pg_dump` и `pg_restore` |

## Лицензия <a name="license"></a>

Проект доступен с открытым исходным кодом на условиях [Лицензии GNU GPL 3](https://opensource.org/license/gpl-3-0/). \
*Авторские права 2025 Max Barsukov*

**Поставьте звезду :star:, если вы нашли этот проект полезным.**
