# Задания

### Вопрос

Посмотрите, какие у вас запущены процессы. Выберите один (например, оболочку, которой вы пользуетесь) и посмотрите на содержимое директории `/proc/PID/`, где `PID` — его идентификатор.

### Вопрос

Что внутри файла `/proc/PID/environ`?

### Вопрос

Прочитайте про запуск программ в фоне. Что делают команды `bg`, `fg`, `jobs`?
Напишем [простую программу](./questions/q1.asm), которая входит в бесконечный цикл:

```nasm
section .data
correct: dq -1
section .text
global _start
_start:
jmp _start
```

Что она делает? Скомпилируйте и запустите её в фоне.

### Вопрос

Выведите с помощью `cat` содержимое файла `/proc/PID/maps`, где `PID` — идентификатор процесса, который вы запустили в фоне.

### Вопрос

Почему в регионах начальный и конечный адрес в 16-ричном формате заканчиваются всегда на три нуля?

### Вопрос

Определите, по каким адресам загружаются секции `.text` и `.data` из примера. Вам может помочь `readelf` и таблица символов.

### Вопрос

Определите хотя бы один запрещённый диапазон адресов.

### Вопрос

Что такое inode в файловой системе?

### Вопрос

Что находится в остальных столбцах? Прочитайте про файл `/proc/PID/maps` в `man procfs`.

### Вопрос

Прочитайте в `man mmap` ответы на следующие вопросы: Какие аргументы принимает `mmap`? В чём их смысл? Какой аргумент в каком регистре?


## Задание 1

Создайте файл `hello.txt` с текстом `Hello, mmap!`. Используя заготовку, отобразите его в память и выведите текст из него в стандартный поток вывода. Не забудьте вызвать `munmap` (его номер системного вызова `11`) и закрыть файл (`close`, номер системного вызова `3`) по завершению работы с файлом.

- [hello_mmap.asm](./task1/hello_mmap.asm)

[task1](./task1/)

## Задание 2

Прочитайте документацию по системному вызову `fstat` (номер `5`). Вас будет интересовать поле `st_size` типа `off_t` структуры `struct stat`, которую функция `fstat` заполняет. Используйте его, чтобы корректно вычислить размер файла при выводе данных, и выведите их, используя функцию `print_substring` (принимает на вход два аргумента: адрес начала строки и количество байт для вывода). Полученный размер файла используйте в вызовах `mmap`, `munmap` и `print_substring`.

Для выполнения задания вам пригодиться следующая информация:

```c
sizeof(struct stat) = 144
offsetof(struct stat, st_size) = 48
sizeof(off_t) = 8
```

Для выделения памяти на хранение структуры `stat` рекомендуется использовать стек.

[task2](./task2/)

### Вопрос

Что делает функция `world`? Объясните принцип её работы.

[string.asm](./questions/string.asm)

## Задание 3

В этих файлах не хватает нескольких строчек чтобы можно было взаимодействовать с кодом друг друга. Допишите файлы так, чтобы функции `print_string` и `hello` вызывалась и проверьте результат. Подсказка: вспомните, что нужно, чтобы из одного файла с C-кодом вызвать код из другого файла.

[task3](./task3/)

### Вопрос

Какие аргументы может принимает функция языка С по умолчанию? В чем отличие прототипов `int f();` и `int f(void);`?

### Вопрос

Изучите `Makefile` [для сборки этой программы](./makefile). Что означают `$@`, `$^`?

- `$@` - цель (имя файла для сборки) текущего правила.
- `$^` - список всех зависимостей текущего правила, разделенных пробелами. Повторные включения зависимостей удаляются (каждая зависимость включается в список ровно один раз).

### Вопрос

Что такое секции `.rodata` и `.bss`?

### Вопрос

Что в `nasm` делают директивы `resb`, `resq` и [другие](https://nasm.us/doc/nasmdoc3.html)?

### Вопрос

В файле `hello.c`, в какой секции будет выделена строка `=”hello”=`?

### Вопрос

Введите `readelf` без аргументов. Прочитайте вывод и определите, какие ключи необходимы, чтобы отобразить три заголовка файла.

### Вопрос

Выведите `file header` (ключ `-h` или `--file-header`) для файла `hello.o`. Что такое `Entry point address` и почему его значение `0`?

### Вопрос

Выведите `program header` (ключ `-l` или `--program-headers`) для файла `hello.o`. Объясните результат.

### Вопрос

Определите адреса загрузки секций `.text` и `.rodata` используя список секций (ключ `-S` или `--section-headers`).

### Вопрос

Выведите `program header` для файла `hello`. В какие сегменты попадают `.text` и `.rodata`? Какие адреса загрузки этих сегментов?

### Вопрос

Модифицируйте программу на C так, чтобы она входила в бесконечный цикл. Это позволит нам проверить наши догадки про адреса секций и сегментов.

### Вопрос

Выведите карту регионов памяти для запущенной программы, с которой мы сегодня работаем. Сопоставьте сегменты, содержащие секции `.rodata` и `.text` регионам памяти. Верно ли, что одному региону памяти соответствует только один сегмент?

### Вопрос

Какие регионы соответствуют частям динамических библиотек? У динамических библиотек в Linux расширение `*.so`.

### Вопрос

Выполните `ldd hello`. Объясните результат.

### Вопрос

Как вы думаете, почему стандартная библиотека C реализована как динамическая библиотека, а не включается в состав исполняемого файла статически, как обычные `.o` файлы?

## Задание 4

Объедините ассемблерный код для вывода содержимого файла с кодом на языке C. Пусть ваша программа будет просить пользователя ввести название файла, а затем выведет его содержимое в стандартный поток вывода используя код, написанный в начале сегодняшнего семинара (сделайте из него функцию `print_file`, которая будет принимать имя файла первым аргументом). Не забудьте, что для корректной работы необходимо следовать соглашениям о вызовах и сохранить `callee-saved` регистры, которые вы используете, в начале своей функции `print_file`. Для вывода сообщений (например `“Please enter file name: “`) используйте собственную реализацию `print_string` из сегодняшнего семинара.
Желающие могут прочитать больше про регионы `[vdso]` и `[vvar]`, использующиеся для ускорения некоторых системных вызовов:

- `man vdso`
- [Implementing virtual system calls](https://lwn.net/Articles/615809/)

[task4](./task4/)
